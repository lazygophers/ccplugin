# lib - CCPlugin å…±äº«åº“

> ä¸º CCPlugin æ’ä»¶æä¾›ç»Ÿä¸€çš„æ—¥å¿—ã€Hook ç³»ç»Ÿå’Œç¯å¢ƒå˜é‡ç®¡ç†

## æ¦‚è¿°

`lib` æ˜¯ CCPlugin ç”Ÿæ€çš„å…±äº«åº“ï¼Œä¸ºæ‰€æœ‰æ’ä»¶æä¾›ï¼š

- **æ—¥å¿—ç³»ç»Ÿ** (`logging/`) - åŸºäº Rich çš„å½©è‰²æ—¥å¿—ï¼Œè‡ªåŠ¨åˆ†å‰²æ–‡ä»¶
- **Hook ç³»ç»Ÿ** (`hooks/`) - ä» stdin è¯»å– JSON æ•°æ®çš„äº‹ä»¶å¤„ç†å™¨
- **ç¯å¢ƒç®¡ç†** (`utils/`) - é¡¹ç›®ç›®å½•ã€æ’ä»¶è·¯å¾„çš„ç¯å¢ƒå˜é‡

**è®¾è®¡ç†å¿µï¼š** å•å®ä¾‹ã€ç®€æ´ APIã€è‡ªåŠ¨æ¸…ç†ã€ä¾èµ–éš”ç¦»

---

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
cd lib/
uv sync
```

### åŸºç¡€ä½¿ç”¨

```python
# æ—¥å¿—
from lib import info, error, warn
info("æ“ä½œå¯åŠ¨")
error("å‘ç”Ÿé”™è¯¯")

# Hook
from lib.hooks import load_hooks
hook_data = load_hooks()

# ç¯å¢ƒ
from lib.utils import get_project_dir
project_dir = get_project_dir()
```

---

## API å‚è€ƒ

### æ—¥å¿—æ¨¡å— (`lib.logging`)

**å¯¼å‡ºå‡½æ•°ï¼š**

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `info(message: str)` | è®°å½• INFO çº§åˆ«æ—¥å¿— |
| `debug(message: str)` | è®°å½• DEBUG çº§åˆ«æ—¥å¿—ï¼ˆéœ€å¯ç”¨ DEBUG æ¨¡å¼ï¼‰ |
| `error(message: str)` | è®°å½• ERROR çº§åˆ«æ—¥å¿— |
| `warn(message: str)` | è®°å½• WARNING çº§åˆ«æ—¥å¿— |
| `enable_debug()` | å¯ç”¨ DEBUG æ¨¡å¼ï¼ˆæ§åˆ¶å°è¾“å‡ºï¼‰ |

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```python
from lib.logging import info, error, enable_debug, debug

# åŸºç¡€æ—¥å¿—
info("æ“ä½œå®Œæˆ")
error("å‘ç”Ÿé”™è¯¯")

# DEBUG æ¨¡å¼
enable_debug()
debug("è°ƒè¯•ä¿¡æ¯")
```

**æ—¥å¿—æ ¼å¼ï¼š**

```
â„¹ï¸  INFO [2026-01-21 14:30:00] åº”ç”¨å¯åŠ¨
âš ï¸  WARNING [2026-01-21 14:30:01] è¿™æ˜¯ä¸€æ¡è­¦å‘Š
âŒ ERROR [2026-01-21 14:30:02] å‘ç”Ÿé”™è¯¯
ğŸ› DEBUG [2026-01-21 14:30:03] è°ƒè¯•ä¿¡æ¯
```

**æ—¥å¿—å­˜å‚¨ï¼š**

- ä½ç½®ï¼š`./lazygophers/ccplugin/log/`
- å‘½åï¼š`YYYYMMDDHH.log`ï¼ˆæŒ‰å°æ—¶åˆ†å‰²ï¼‰
- ä¿ç•™ï¼šæœ€æ–° 3 ä¸ªæ–‡ä»¶ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰

---

### Hook æ¨¡å— (`lib.hooks`)

**å¯¼å‡ºå‡½æ•°ï¼š**

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `load_hooks()` | ä» stdin è¯»å– JSON Hook æ•°æ® |

**Hook æ•°æ®æ ¼å¼ï¼š**

```json
{
  "hook_event_name": "SessionStart",
  "source": "startup",
  "message": "Session started"
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```python
from lib.hooks import load_hooks

def handle_hook():
    hook_data = load_hooks()
    event_name = hook_data.get("hook_event_name")

    if event_name == "SessionStart":
        # å¤„ç†ä¼šè¯å¼€å§‹äº‹ä»¶
        pass
```

**SessionStart ç‰¹æ®Šå¤„ç†ï¼š**

- è‡ªåŠ¨è¾“å‡º `AGENT.md` æ–‡ä»¶å†…å®¹
- æ›¿æ¢ `${CLAUDE_PLUGIN_ROOT}` ä¸ºå®é™…è·¯å¾„

---

### ç¯å¢ƒæ¨¡å— (`lib.utils`)

**å¯¼å‡ºå‡½æ•°ï¼š**

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `get_project_dir()` | è·å–é¡¹ç›®æ ¹ç›®å½•ï¼ˆæ¥è‡ª `CLAUDE_PROJECT_DIR` æˆ–å½“å‰ç›®å½•ï¼‰ |
| `get_project_plugins_dir()` | è·å–é¡¹ç›®æ’ä»¶ç›®å½• `<project>/.lazygophers/ccplugin/` |
| `get_plugins_path()` | è·å–æ’ä»¶è·¯å¾„ï¼ˆåŒä¸Šï¼‰ |
| `get_user_plugins_dir()` | è·å–ç”¨æˆ·æ’ä»¶ç›®å½• `~/.lazygophers/ccplugin/` |
| `get_plugins_skills_dir()` | è·å–æ’ä»¶ skills ç›®å½• |
| `get_plugins_commands_dir()` | è·å–æ’ä»¶ commands ç›®å½• |
| `get_plugins_hooks_dir()` | è·å–æ’ä»¶ hooks ç›®å½• |
| `get_plugins_agents_dir()` | è·å–æ’ä»¶ agents ç›®å½• |
| `set_app(name: str)` | è®¾ç½®åº”ç”¨åç§°ï¼ˆæ¥è‡ª `PLUGIN_NAME` ç¯å¢ƒå˜é‡ï¼‰ |
| `get_app_name()` | è·å–åº”ç”¨åç§° |

**ç¯å¢ƒå˜é‡ï¼š**

| å˜é‡ | è¯´æ˜ | æ¥æº |
|------|------|------|
| `CLAUDE_PROJECT_DIR` | é¡¹ç›®æ ¹ç›®å½• | Claude Code è®¾ç½® |
| `CLAUDE_PLUGIN_ROOT` | æ’ä»¶æ ¹ç›®å½• | Claude Code è®¾ç½® |
| `PLUGIN_NAME` | æ’ä»¶åç§° | é…ç½®æ–‡ä»¶è®¾ç½® |

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```python
from lib.utils import get_project_dir, get_project_plugins_dir, set_app

# è·å–é¡¹ç›®ç›®å½•
project_dir = get_project_dir()  # CLAUDE_PROJECT_DIR æˆ– os.getcwd()

# è·å–æ’ä»¶æ•°æ®ç›®å½•
plugin_dir = get_project_plugins_dir()  # <project>/.lazygophers/ccplugin/

# è®¾ç½®åº”ç”¨åç§°
set_app("my-plugin")
app_name = get_app_name()  # "my-plugin"
```

---

## ä¾èµ–

**Pythonï¼š** >= 3.12ï¼ˆå¼ºåˆ¶ï¼‰

**æ ¸å¿ƒä¾èµ–ï¼š**

```toml
[project]
dependencies = [
    "pydantic>=2.12.5",     # æ•°æ®éªŒè¯
    "pytest>=9.0.2",        # æµ‹è¯•æ¡†æ¶
    "rich>=13.0.0",         # ç»ˆç«¯ç¾åŒ–
]
```

---

## ç›®å½•ç»“æ„

```
lib/
â”œâ”€â”€ __init__.py           # é¡¶å±‚å¯¼å‡ºï¼ˆæ—¥å¿—å‡½æ•°ï¼‰
â”œâ”€â”€ logging/              # æ—¥å¿—æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py      # å¯¼å‡º info/debug/error/warn/enable_debug
â”‚   â”œâ”€â”€ manager.py       # RichLoggerManager å•ä¾‹å®ç°
â”‚   â””â”€â”€ README.md        # æ—¥å¿—æ¨¡å—æ–‡æ¡£
â”œâ”€â”€ hooks/                # Hook æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py      # å¯¼å‡º load_hooks
â”‚   â””â”€â”€ hook.py          # load_hooks å®ç°
â”œâ”€â”€ utils/                # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py      # å¯¼å‡ºç¯å¢ƒå˜é‡å‡½æ•°
â”‚   â””â”€â”€ env.py           # Env ç±»å’Œå‡½æ•°å®ç°
â”œâ”€â”€ tests/                # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ test_logging.py
â”œâ”€â”€ pyproject.toml        # é¡¹ç›®é…ç½®
â””â”€â”€ uv.lock               # ä¾èµ–é”å®š
```

---

## è®¾è®¡åŸåˆ™

### 1. å•å®ä¾‹æ¨¡å¼

**æ—¥å¿—ç®¡ç†å™¨** å’Œ **ç¯å¢ƒç®¡ç†å™¨** ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€å®ä¾‹ã€‚

```python
# manager.py (ç®€åŒ–ç¤ºä¾‹)
class RichLoggerManager:
    _instance = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance

_logger = RichLoggerManager()

def info(message: str):
    _logger.info(message)
```

### 2. ç®€æ´ API

åªå¯¼å‡ºå¿…è¦çš„å‡½æ•°ï¼Œé¿å…å¤æ‚é…ç½®ã€‚

```python
# âœ… æ­£ç¡®ï¼šç®€æ´
from lib import info, error
info("æ¶ˆæ¯")

# âŒ é¿å…ï¼šå¤æ‚
from lib.logging.manager import RichLoggerManager
logger = RichLoggerManager()
logger.log("INFO", "æ¶ˆæ¯")
```

### 3. è‡ªåŠ¨æ¸…ç†

æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨ä¿ç•™æœ€æ–° 3 ä¸ªï¼Œè¿‡æœŸæ–‡ä»¶è‡ªåŠ¨åˆ é™¤ã€‚

```python
# manager.py
def _cleanup_old_logs(self):
    log_files = sorted(glob("*.log"), reverse=True)
    for old_log in log_files[3:]:
        os.remove(old_log)
```

### 4. ç¯å¢ƒå˜é‡ä¼˜å…ˆ

Claude Code è®¾ç½®çš„ç¯å¢ƒå˜é‡ä¼˜å…ˆäºé»˜è®¤å€¼ã€‚

```python
# env.py
def __init__(self):
    if os.getenv("CLAUDE_PROJECT_DIR"):
        self.project_dir = os.getenv("CLAUDE_PROJECT_DIR")
    else:
        self.project_dir = os.getcwd()
```

---

## æµ‹è¯•

è¿è¡Œå•å…ƒæµ‹è¯•ï¼š

```bash
cd lib/
uv run pytest tests/ -v
```

æµ‹è¯•è¦†ç›–ï¼š
- âœ… æ‰€æœ‰æ—¥å¿—çº§åˆ«å‡½æ•°
- âœ… DEBUG æ¨¡å¼å¯ç”¨
- âœ… æ—¥å¿—æ–‡ä»¶åˆ›å»ºå’Œæ ¼å¼
- âœ… æ—§æ—¥å¿—æ–‡ä»¶æ¸…ç†
- âœ… å•ä¾‹æ¨¡å¼
- âœ… API å¯è®¿é—®æ€§

---

## ä½¿ç”¨è§„èŒƒ

### å¿…é¡»ä½¿ç”¨å…±äº«åº“

**æ’ä»¶ç¦æ­¢é‡å¤å®ç°**æ—¥å¿—å’Œ Hook åŠŸèƒ½ï¼š

```python
# âœ… æ­£ç¡®ï¼šä½¿ç”¨å…±äº«åº“
from lib import logging
from lib.hooks import load_hooks

# âŒ é”™è¯¯ï¼šè‡ªå·±å®ç°
import logging
import json
```

### å¯¼å…¥é¡ºåº

```python
# 1. æ ‡å‡†åº“
import os
import sys

# 2. ç¬¬ä¸‰æ–¹åº“
import click
from rich.console import Console

# 3. å…±äº«åº“ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
from lib import logging
from lib.hooks import load_hooks
from lib.utils import get_project_dir
```

### é”™è¯¯å¤„ç†

Hook å’Œæ—¥å¿—å‡½æ•°å·²å†…ç½®å¼‚å¸¸å¤„ç†ï¼Œç›´æ¥ä½¿ç”¨å³å¯ï¼š

```python
# ä¸éœ€è¦ try-except
hook_data = load_hooks()  # å¤±è´¥æ—¶è‡ªåŠ¨ sys.exit(1)

# ä¸éœ€è¦æ£€æŸ¥æ–‡ä»¶å­˜åœ¨
info("æ¶ˆæ¯")  # è‡ªåŠ¨å¤„ç†æ–‡ä»¶åˆ›å»º
```

---

## å¸¸è§é—®é¢˜

**Q: æ—¥å¿—æ–‡ä»¶åœ¨å“ªé‡Œï¼Ÿ**

A: `./lazygophers/ccplugin/log/YYYYMMDDHH.log`

**Q: å¦‚ä½•å¯ç”¨ DEBUG æ¨¡å¼ï¼Ÿ**

A: è°ƒç”¨ `enable_debug()`ï¼ŒDEBUG æ—¥å¿—ä¼šè¾“å‡ºåˆ°æ§åˆ¶å°ã€‚

**Q: å¦‚ä½•è·å–é¡¹ç›®ç›®å½•ï¼Ÿ**

A: ä½¿ç”¨ `get_project_dir()`ï¼Œä¼˜å…ˆä½¿ç”¨ `CLAUDE_PROJECT_DIR` ç¯å¢ƒå˜é‡ã€‚

**Q: å•ä¾‹æ¨¡å¼ä¼šå¯¼è‡´é—®é¢˜å—ï¼Ÿ**

A: ä¸ä¼šã€‚å•ä¾‹ç¡®ä¿å…¨å±€ä¸€è‡´æ€§ï¼Œé€‚åˆæ—¥å¿—å’Œç¯å¢ƒç®¡ç†ã€‚

---

## ç›¸å…³æ–‡æ¡£

- [logging/README.md](logging/README.md) - æ—¥å¿—æ¨¡å—è¯¦ç»†æ–‡æ¡£
- [../CLAUDE.md](../CLAUDE.md) - é¡¹ç›®ä¸»æ–‡æ¡£
- [../.claude/skills/python-script-organization/](../.claude/skills/python-script-organization/SKILL.md) - Python è„šæœ¬ç»„ç»‡è§„èŒƒ

---

## è®¸å¯è¯

AGPL-3.0-or-later
