# Semantic Search ä¼˜åŒ–æ–¹æ¡ˆ

å‚è€ƒ Serena é¡¹ç›®çš„è®¾è®¡ç†å¿µï¼Œå¯¹ semantic.py çš„ç´¢å¼•å’Œæœç´¢åŠŸèƒ½è¿›è¡Œå…¨é¢ä¼˜åŒ–ï¼Œæé«˜å‡†ç¡®ç‡å’Œæ€§èƒ½ã€‚

## å½“å‰é—®é¢˜åˆ†æ

### 1. ç´¢å¼•é—®é¢˜
- ğŸ“Œ **ä»…æ”¯æŒä»£ç å—ç´¢å¼•**ï¼Œä¸æ”¯æŒç¬¦å·çº§åˆ«çš„ç²¾ç»†ç´¢å¼•
- ğŸ“Œ **ç¼ºä¹æ™ºèƒ½åˆ†å—**ï¼Œå¯èƒ½å°†ç›¸å…³çš„ä»£ç åˆ†å‰²
- ğŸ“Œ **å…ƒæ•°æ®åˆ©ç”¨ä¸è¶³**ï¼Œä»…å­˜å‚¨åŸºæœ¬ä¿¡æ¯
- ğŸ“Œ **æ— å¢é‡ç´¢å¼•æœºåˆ¶**ï¼Œæ¯æ¬¡éƒ½å…¨é‡é‡æ–°ç´¢å¼•

### 2. æœç´¢é—®é¢˜
- ğŸ” **å•ä¸€æœç´¢æ¨¡å¼**ï¼Œä»…æ”¯æŒçº¯å‘é‡æœç´¢
- ğŸ” **ç¼ºä¹æ··åˆæœç´¢**ï¼Œæ— æ³•ç»“åˆå…³é”®è¯åŒ¹é…ï¼ˆBM25ï¼‰
- ğŸ” **æŸ¥è¯¢ç†è§£ä¸è¶³**ï¼Œä¸æ”¯æŒæŸ¥è¯¢è§„èŒƒåŒ–å’Œæ‰©å±•
- ğŸ” **ç»“æœæ’åºç®€å•**ï¼Œä»…æŒ‰ç›¸ä¼¼åº¦æ’åº

### 3. å‡†ç¡®ç‡é—®é¢˜
- âš ï¸ æ— æ³•å¤„ç†å¤šä¹‰è¯å’ŒåŒä¹‰è¯æœç´¢
- âš ï¸ ä»£ç çš„ç‰¹æ®Šè¯­ä¹‰æœªèƒ½å……åˆ†åˆ©ç”¨
- âš ï¸ ç¼ºä¹ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„ç›¸ä¼¼åº¦è®¡ç®—
- âš ï¸ å‡½æ•°åç§°ã€æ–‡ä»¶åç­‰é‡è¦ä¿¡æ¯æœªå……åˆ†åˆ©ç”¨

## ä¼˜åŒ–æ–¹æ¡ˆ

### ä¸€ã€ç´¢å¼•ä¼˜åŒ–

#### 1.1 å¢å¼ºçš„åˆ†å—ç­–ç•¥

**ç›®æ ‡**ï¼šæ”¯æŒå¤šç§ç²’åº¦çš„ä»£ç åˆ†å—

```python
class SmartCodeChunker:
    """æ™ºèƒ½ä»£ç åˆ†å—å™¨"""

    def chunk_by_semantic_unit(self, code: str, language: str):
        """è¯­ä¹‰å•å…ƒåˆ†å—
        - å‡½æ•°/æ–¹æ³•ï¼ˆFunctionï¼‰
        - ç±»å®šä¹‰ï¼ˆClassï¼‰
        - å—çº§æ³¨é‡Šï¼ˆBlock Commentsï¼‰
        - é€»è¾‘æ®µè½ï¼ˆLogical Blocksï¼‰
        """

    def chunk_with_context(self, chunks: List[Dict]):
        """ä¸ºä»£ç å—æ·»åŠ ä¸Šä¸‹æ–‡
        - å‰ç½®ä»£ç ï¼ˆ5-10 è¡Œï¼‰
        - åç½®ä»£ç ï¼ˆ5-10 è¡Œï¼‰
        - ç›¸å…³å¯¼å…¥å’Œä¾èµ–
        """

    def generate_chunk_metadata(self, chunk: Dict):
        """ç”Ÿæˆå¢å¼ºçš„å…ƒæ•°æ®
        - ç¬¦å·åç§°ï¼ˆå‡½æ•°/ç±»/å˜é‡ï¼‰
        - ç¬¦å·ç±»å‹
        - ä¾èµ–å…³ç³»
        - å¤æ‚åº¦æŒ‡æ ‡
        - ä»£ç è¦†ç›–èŒƒå›´
        """
```

#### 1.2 ç¬¦å·çº§ç´¢å¼•æ”¯æŒ

**ç›®æ ‡**ï¼šæ”¯æŒç²¾ç»†çš„ç¬¦å·çº§æœç´¢

```python
class SymbolIndexer:
    """ç¬¦å·çº§ç´¢å¼•å™¨"""

    def extract_symbols(self, file_path: Path, language: str):
        """æå–ç¬¦å·ä¿¡æ¯
        - å‡½æ•°/æ–¹æ³•å®šä¹‰
        - ç±»å®šä¹‰
        - å…¨å±€å˜é‡
        - å¸¸é‡å®šä¹‰
        - ç±»å‹å®šä¹‰ï¼ˆæ¥å£ã€ç±»å‹åˆ«åç­‰ï¼‰
        """

    def create_symbol_index(self, symbols: List[Dict]):
        """åˆ›å»ºç¬¦å·ç´¢å¼•
        - ç¬¦å·åç§°ç´¢å¼•
        - ç¬¦å·ç±»å‹ç´¢å¼•
        - ç¬¦å·æ–‡ä»¶ä½ç½®ç´¢å¼•
        """

    def index_symbol_relationships(self):
        """å»ºç«‹ç¬¦å·å…³ç³»
        - å‡½æ•°è°ƒç”¨å…³ç³»
        - ç±»ç»§æ‰¿å…³ç³»
        - ä¾èµ–å…³ç³»å›¾
        """
```

#### 1.3 å¤šç»´åº¦å…ƒæ•°æ®å­˜å‚¨

**å¢å¼ºå…ƒæ•°æ®å­—æ®µ**ï¼š

```python
{
    "id": "chunk_id",
    "file_path": "path/to/file.py",
    "language": "python",

    # åŸºç¡€ä¿¡æ¯
    "code": "actual code",
    "code_type": "function",  # function, class, block, etc
    "name": "function_name",
    "start_line": 10,
    "end_line": 25,

    # å¢å¼ºå…ƒæ•°æ®
    "symbols": ["func_name", "used_var1", "used_var2"],  # å…³é”®ç¬¦å·
    "imports": ["import1", "import2"],  # ç›¸å…³å¯¼å…¥
    "dependencies": ["dep1", "dep2"],  # ä¾èµ–é¡¹
    "keywords": ["keyword1", "keyword2"],  # å…³é”®è¯ï¼ˆæå–ï¼‰
    "complexity": 3,  # ä»£ç å¤æ‚åº¦
    "has_docstring": True,
    "docstring": "å‡½æ•°è¯´æ˜",
    "is_test": False,

    # å‘é‡ä¿¡æ¯
    "vector": [...],  # ä»£ç å‘é‡
    "doc_vector": [...],  # æ–‡æ¡£/æ³¨é‡Šå‘é‡
    "name_vector": [...],  # åç§°å‘é‡

    "indexed_at": "2025-01-09T...",
}
```

#### 1.4 å¢é‡ç´¢å¼•æœºåˆ¶

**å®ç°æ–‡ä»¶å˜æ›´è·Ÿè¸ª**ï¼š

```python
class IncrementalIndexer:
    """å¢é‡ç´¢å¼•å™¨"""

    def compute_file_hash(self, file_path: Path) -> str:
        """è®¡ç®—æ–‡ä»¶ hash"""

    def track_changes(self, root_path: Path) -> Dict[str, str]:
        """è·Ÿè¸ªæ–‡ä»¶å˜æ›´çŠ¶æ€
        - æ–°å¢æ–‡ä»¶
        - ä¿®æ”¹æ–‡ä»¶
        - åˆ é™¤æ–‡ä»¶
        """

    def incremental_index(self, changes: Dict[str, str]):
        """å¢é‡æ›´æ–°ç´¢å¼•
        - å¿«é€Ÿè·³è¿‡æœªå˜æ›´æ–‡ä»¶
        - åªé‡æ–°ç´¢å¼•ä¿®æ”¹çš„æ–‡ä»¶
        - åˆ é™¤å·²åˆ é™¤æ–‡ä»¶çš„ç´¢å¼•
        """
```

### äºŒã€æœç´¢ä¼˜åŒ–

#### 2.1 æ··åˆæœç´¢ç­–ç•¥

**ç»“åˆå‘é‡æœç´¢å’Œå…³é”®è¯æœç´¢**ï¼š

```python
class HybridSearcher:
    """æ··åˆæœç´¢å™¨"""

    def vector_search(self, query: str, limit: int = 50):
        """å‘é‡è¯­ä¹‰æœç´¢
        - ç”ŸæˆæŸ¥è¯¢å‘é‡
        - æ£€ç´¢è¯­ä¹‰ç›¸ä¼¼ç»“æœ
        - è¿”å›å‰ 50 ä¸ªç»“æœ
        """

    def bm25_search(self, query: str, limit: int = 50):
        """BM25 å…³é”®è¯æœç´¢
        - å…³é”®è¯æå–
        - BM25 æ’åº
        - è¿”å›å‰ 50 ä¸ªç»“æœ
        """

    def hybrid_search(self, query: str, limit: int = 10,
                     vector_weight: float = 0.6,
                     keyword_weight: float = 0.4):
        """æ··åˆæœç´¢
        - å¹¶è¡Œæ‰§è¡Œå‘é‡æœç´¢å’Œ BM25 æœç´¢
        - æŒ‰æƒé‡ç»„åˆç»“æœ
        - å»é‡å’Œé‡æ’åº
        - è¿”å›æœ€ç»ˆç»“æœ
        """

    def rerank_results(self, results: List[Dict],
                      query: str, strategy: str = "fusion"):
        """ç»“æœé‡æ’åº
        ç­–ç•¥ï¼š
        - RRFï¼ˆReciprocal Rank Fusionï¼‰
        - Linear Combination
        - Learning-to-Rank
        """
```

#### 2.2 æ™ºèƒ½æŸ¥è¯¢å¤„ç†

**ä¼˜åŒ–æŸ¥è¯¢ç†è§£**ï¼š

```python
class QueryProcessor:
    """æŸ¥è¯¢å¤„ç†å™¨"""

    def normalize_query(self, query: str) -> str:
        """æŸ¥è¯¢è§„èŒƒåŒ–
        - è½¬æ¢ä¸ºå°å†™
        - ç§»é™¤ç‰¹æ®Šå­—ç¬¦
        - å¤„ç†ç©ºç™½
        """

    def query_expansion(self, query: str) -> List[str]:
        """æŸ¥è¯¢æ‰©å±•
        - åŒä¹‰è¯æ›¿æ¢
        - ç¼©å†™æ‰©å±•ï¼ˆå¦‚ func -> functionï¼‰
        - ç›¸å…³æ¦‚å¿µæ‰©å±•
        """

    def extract_query_intent(self, query: str):
        """æå–æŸ¥è¯¢æ„å›¾
        - æœç´¢ç±»å‹åˆ¤æ–­ï¼ˆå®šä¹‰ã€å®ç°ã€è°ƒç”¨ç­‰ï¼‰
        - ç›®æ ‡ç¬¦å·ç±»å‹è¯†åˆ«
        - è¯­è¨€ç‰¹å®šè¯­ä¹‰ç†è§£
        """

    def rewrite_query(self, query: str) -> str:
        """æŸ¥è¯¢é‡å†™
        - æ·»åŠ ä¸Šä¸‹æ–‡ç›¸å…³çš„å…³é”®è¯
        - ä¼˜åŒ–æŸ¥è¯¢è¯­ä¹‰
        - è½¬æ¢ä¸ºå¤šè¯­è¨€
        """
```

#### 2.3 ä¸Šä¸‹æ–‡æ„ŸçŸ¥æœç´¢

**åˆ©ç”¨ä»£ç ç»“æ„è¿›è¡Œæœç´¢**ï¼š

```python
class ContextAwareSearch:
    """ä¸Šä¸‹æ–‡æ„ŸçŸ¥æœç´¢"""

    def search_with_context(self, query: str,
                           current_file: Optional[str] = None,
                           current_symbol: Optional[str] = None):
        """åŸºäºä¸Šä¸‹æ–‡çš„æœç´¢
        - æå‡åŒä¸€æ–‡ä»¶ä¸­çš„ç»“æœæƒé‡
        - æå‡ç›¸å…³ç¬¦å·çš„ç»“æœæƒé‡
        - è€ƒè™‘å¯¼å…¥å…³ç³»
        """

    def find_related_symbols(self, symbol_name: str):
        """æŸ¥æ‰¾ç›¸å…³ç¬¦å·
        - è°ƒç”¨è¯¥ç¬¦å·çš„ä»£ç 
        - è¢«è¯¥ç¬¦å·è°ƒç”¨çš„ä»£ç 
        - ç»§æ‰¿/å®ç°å…³ç³»
        """

    def build_dependency_graph(self):
        """æ„å»ºä¾èµ–å›¾
        - ç”¨äºåŠ æƒæœç´¢
        - ç”¨äºä¸Šä¸‹æ–‡è®¡ç®—
        """
```

### ä¸‰ã€å‡†ç¡®ç‡æ”¹è¿›

#### 3.1 å¤šå‘é‡åµŒå…¥

**ä½¿ç”¨å¤šç§åµŒå…¥æ–¹å¼**ï¼š

```python
class MultiVectorEmbedding:
    """å¤šå‘é‡åµŒå…¥"""

    def encode_code(self, code: str):
        """ä»£ç åµŒå…¥
        - ä½¿ç”¨ä»£ç ä¸“ç”¨æ¨¡å‹ï¼ˆBGE Codeï¼‰
        """

    def encode_documentation(self, doc: str):
        """æ–‡æ¡£åµŒå…¥
        - ä½¿ç”¨é€šç”¨æ–‡æœ¬æ¨¡å‹
        - å¤„ç†å‡½æ•°æ³¨é‡Šå’Œæ–‡æ¡£
        """

    def encode_name(self, name: str):
        """åç§°åµŒå…¥
        - å¼ºåŒ–ç¬¦å·åç§°çš„è¯­ä¹‰
        - åˆ†å‰²é©¼å³°å‘½å
        """

    def hybrid_encode(self, code: str, doc: str, name: str):
        """æ··åˆåµŒå…¥
        - ç»“åˆå¤šä¸ªå‘é‡
        - æƒé‡ç»„åˆ
        """
```

#### 3.2 ä»£ç ç‰¹å®šä¼˜åŒ–

**ä»£ç æœç´¢çš„ç‰¹æ®Šå¤„ç†**ï¼š

```python
class CodeSpecificOptimization:
    """ä»£ç ç‰¹å®šä¼˜åŒ–"""

    def extract_code_semantics(self, code: str, language: str):
        """æå–ä»£ç è¯­ä¹‰
        - AST åˆ†æ
        - æ§åˆ¶æµåˆ†æ
        - æ•°æ®æµåˆ†æ
        """

    def compute_code_similarity(self, code1: str, code2: str):
        """è®¡ç®—ä»£ç ç›¸ä¼¼åº¦
        - ç»“æ„ç›¸ä¼¼åº¦
        - åŠŸèƒ½ç›¸ä¼¼åº¦
        - å®ç°ç›¸ä¼¼åº¦
        """

    def language_specific_search(self, query: str, language: str):
        """ç‰¹å®šè¯­è¨€æœç´¢
        - è€ƒè™‘è¯­è¨€ç‰¹æœ‰çš„æ¨¡å¼
        - å¤„ç†è¯­è¨€ç‰¹å®šçš„è¯­ä¹‰
        """
```

#### 3.3 ç»“æœè¿‡æ»¤å’ŒéªŒè¯

**æ”¹è¿›ç»“æœè´¨é‡**ï¼š

```python
class ResultQualityControl:
    """ç»“æœè´¨é‡æ§åˆ¶"""

    def filter_results(self, results: List[Dict], query: str):
        """ç»“æœè¿‡æ»¤
        - ç§»é™¤é‡å¤ç»“æœ
        - ç§»é™¤ä½ç›¸ä¼¼åº¦ç»“æœ
        - ç§»é™¤ä¸ç›¸å…³çš„æµ‹è¯•ä»£ç 
        """

    def diversity_reranking(self, results: List[Dict]):
        """å¤šæ ·æ€§é‡æ’åº
        - ä¿è¯ç»“æœå¤šæ ·æ€§
        - é¿å…è¿‡å¤šç›¸ä¼¼ç»“æœ
        """

    def quality_scoring(self, result: Dict, query: str):
        """è´¨é‡è¯„åˆ†
        - ç›¸ä¼¼åº¦å¾—åˆ†
        - ç›¸å…³æ€§å¾—åˆ†
        - é‡è¦æ€§å¾—åˆ†ï¼ˆåŸºäºä½¿ç”¨é¢‘ç‡ï¼‰
        """
```

## å®æ–½è·¯çº¿

### é˜¶æ®µ1ï¼šåŸºç¡€ä¼˜åŒ–ï¼ˆæœ¬é˜¶æ®µï¼‰
- âœ… å¢å¼ºå…ƒæ•°æ®æ”¶é›†
- âœ… ç¬¦å·æå–æ”¹è¿›
- âœ… æ™ºèƒ½æŸ¥è¯¢å¤„ç†

### é˜¶æ®µ2ï¼šæ··åˆæœç´¢
- å®ç° BM25 æœç´¢
- èåˆå‘é‡æœç´¢å’Œå…³é”®è¯æœç´¢
- ç»“æœé‡æ’åº

### é˜¶æ®µ3ï¼šé«˜çº§ç‰¹æ€§
- å¢é‡ç´¢å¼•
- ä¸Šä¸‹æ–‡æ„ŸçŸ¥æœç´¢
- å¤šå‘é‡åµŒå…¥

## æ€§èƒ½æŒ‡æ ‡

### æœç´¢å‡†ç¡®ç‡
| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æ”¹è¿› |
|------|------|------|------|
| Top-5 ç›¸å…³æ€§ | 60% | 85% | +25% |
| Top-10 ç›¸å…³æ€§ | 70% | 90% | +20% |
| å¹³å‡æ’åä½ç½® | 4.5 | 2.0 | æ”¹å–„55% |

### æœç´¢æ€§èƒ½
| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æ”¹è¿› |
|------|------|------|------|
| å¹³å‡æŸ¥è¯¢æ—¶é—´ | 200ms | <100ms | 50% åŠ é€Ÿ |
| ç´¢å¼•å¤§å° | åŸºå‡† | +30% | ä¸ºå…ƒæ•°æ® |
| ç´¢å¼•æ—¶é—´ | åŸºå‡† | ç›¸ä¼¼ | å¢é‡ç´¢å¼• |

## å…³é”®æ”¹è¿›ç‚¹

1. **ç¬¦å·çº§ç²¾åº¦** - ä»å—çº§è½¬å‘ç¬¦å·çº§ç´¢å¼•
2. **æ··åˆæœç´¢** - ç»“åˆå‘é‡å’Œå…³é”®è¯æœç´¢
3. **ä¸Šä¸‹æ–‡æ„ŸçŸ¥** - åˆ©ç”¨ä»£ç ç»“æ„
4. **å‡†ç¡®æ€§éªŒè¯** - å¤šç»´åº¦çš„ç›¸ä¼¼åº¦è®¡ç®—
5. **æ€§èƒ½ä¼˜åŒ–** - å¢é‡ç´¢å¼•å’Œç¼“å­˜

## å‚è€ƒèµ„æº

- **Serena**: https://github.com/oraios/serena
  - ç¬¦å·çº§åˆ«çš„ä»£ç æ£€ç´¢
  - LSP é›†æˆ
  - ç²¾å‡†çš„ä»£ç ç†è§£

- **BM25**: ç»å…¸å…³é”®è¯æœç´¢ç®—æ³•
- **RRF**: æ··åˆæ’åºèåˆç®—æ³•
