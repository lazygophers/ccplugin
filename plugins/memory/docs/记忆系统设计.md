# 记忆系统设计

## 一、记忆分类体系

### 1.1 按形式分类

| 类型 | 描述 | 存储方式 | 示例 |
|------|------|----------|------|
| **Token-level** | 显式文本，可读可改 | SQLite TEXT | 项目结构、代码模式 |
| **Parametric** | 嵌入参数，隐式记忆 | 微调/嵌入 | 用户偏好、编码风格 |
| **Latent** | 潜在状态，激活访问 | 向量/状态 | 上下文关联、隐式知识 |

### 1.2 按功能分类

| 类型 | 描述 | URI 命名空间 | 示例 |
|------|------|--------------|------|
| **事实记忆** | 静态事实 | project://, user:// | 依赖版本、配置信息 |
| **经验记忆** | 动态经验 | workflow://, task:// | 解决方案、错误处理 |
| **工作记忆** | 当前任务 | task://current | 待办事项、进度跟踪 |

### 1.3 按时间维度

| 类型 | 有效期 | 自动清理 | 优先级范围 |
|------|--------|----------|------------|
| **短期记忆** | 会话内 | 会话结束 | 7-10 |
| **中期记忆** | 跨会话 | 30天未访问 | 4-6 |
| **长期记忆** | 永久 | 手动删除 | 0-3 |

---

## 二、URI 命名空间设计

### 2.1 项目级命名空间 (project://)

```
project://
├── structure/           # 项目结构
├── dependencies/        # 依赖管理
├── config/              # 配置信息
└── patterns/            # 项目特定模式
```

### 2.2 工作流命名空间 (workflow://)

```
workflow://
├── commands/            # 常用命令
├── patterns/            # 代码模式
├── solutions/           # 解决方案
└── review/              # 审查流程
```

### 2.3 用户级命名空间 (user://)

```
user://
├── preferences/         # 用户偏好
├── standards/           # 个人标准
└── context/             # 个人上下文
```

### 2.4 任务级命名空间 (task://)

```
task://
├── todos/               # 待办事项
├── progress/            # 进度跟踪
├── blockers/            # 阻塞问题
└── session_log/         # 会话日志
```

### 2.5 系统命名空间 (system://)

```
system://
├── boot                 # 启动加载
├── index                # 全量索引
├── recent               # 最近修改
└── stats                # 统计信息
```

---

## 三、记忆生命周期

### 3.1 形成阶段

| 来源 | 描述 |
|------|------|
| **自动提取** | Hook 从操作中提取 |
| **手动创建** | 用户显式创建 |
| **导入导入** | 从外部文件导入 |
| **推荐创建** | 系统智能推荐 |

### 3.2 演化阶段

| 操作 | 描述 |
|------|------|
| **内容更新** | 修改记忆内容 |
| **版本控制** | 保留历史版本 |
| **优先级调整** | 根据访问频率 |
| **关联建立** | 与其他记忆建立关系 |
| **冲突检测** | 检测矛盾信息 |

### 3.3 检索阶段

| 方式 | 描述 |
|------|------|
| **URI 导航** | 通过路径直接访问 |
| **关键词搜索** | 子串匹配 |
| **语义搜索** | 向量相似度（可选） |
| **上下文召回** | 基于 disclosure 字段 |
| **智能推荐** | 基于当前上下文 |

### 3.4 归档阶段

| 操作 | 描述 |
|------|------|
| **自动归档** | 长期未访问 |
| **手动归档** | 用户主动操作 |
| **合并归档** | 重复内容合并 |
| **删除清理** | 过期或无效记忆 |

### 3.5 状态流转

```
active → deprecated → archived → deleted
```

---

## 四、优先级系统

| 级别 | 含义 | 自动加载 | 使用场景 |
|------|------|----------|----------|
| 0 | 核心身份 | 始终加载 | AI 人格、核心身份 |
| 1 | 关键知识 | 始终加载 | 项目核心配置、关键依赖 |
| 2 | 重要信息 | 始终加载 | 常用命令、重要模式 |
| 3 | 常用参考 | 按需加载 | 常用解决方案、代码片段 |
| 4 | 一般参考 | 按需加载 | 一般模式、参考信息 |
| 5 | 默认级别 | 按需加载 | 普通记忆 |
| 6 | 备用参考 | 手动加载 | 备选方案、历史记录 |
| 7 | 历史存档 | 手动加载 | 过期信息、历史版本 |
| 8 | 临时记忆 | 不加载 | 会话临时数据 |
| 9 | 待清理 | 不加载 | 待删除候选 |
| 10 | 已废弃 | 不加载 | 已标记删除 |

---

## 五、Disclosure 字段设计

### 5.1 作用

描述何时应该召回此记忆

### 5.2 格式

`When <condition>`

### 5.3 示例

- `When starting a new feature`
- `When working with TypeScript files`
- `When reviewing code`
- `When encountering build errors`

### 5.4 使用方式

1. Hook 在 PreToolUse 时分析当前上下文
2. 匹配 disclosure 字段
3. 预加载匹配的记忆

---

## 六、记忆演化机制

### 6.1 版本控制

- 每次修改前创建快照
- 保留完整版本历史
- 支持任意版本回滚
- 版本间差异对比

### 6.2 合并策略

| 策略 | 适用场景 |
|------|----------|
| **append** | 内容互补，顺序追加 |
| **summarize** | 内容冗余，LLM 摘要 |
| **keep_latest** | 时间优先，保留最新 |
| **keep_oldest** | 历史优先，保留最老 |

### 6.3 冲突检测

- 内容相似度分析
- 时间矛盾检测
- 依赖关系冲突

### 6.4 自动归档

- 长期未访问自动降级
- 重复内容自动合并
- 过期信息自动清理
