# 高级特性设计

## 一、智能推荐系统

### 1.1 推荐场景

| 场景 | 触发条件 | 推荐内容 |
|------|----------|----------|
| 模式检测 | 同类操作 ≥3 次 | 创建 workflow://patterns 记忆 |
| 解决方案发现 | 错误修复成功 | 创建 workflow://solutions 记忆 |
| 重复查询 | 相同搜索 ≥2 次 | 创建索引或快捷方式 |
| 新文件类型 | 首次处理某类型文件 | 推荐相关模式记忆 |
| 项目变更 | 检测到结构变化 | 更新 project://structure |

### 1.2 推荐算法

#### 基于文件类型

- 根据文件扩展名匹配 disclosure 字段
- 优先推荐高优先级记忆
- 考虑最近访问时间

#### 基于操作历史

- 分析 session 操作序列
- 提取重复模式
- 推荐创建记忆

#### 基于时间

- 优先推荐最近修改的记忆
- 考虑访问频率
- 时间衰减因子

#### 基于关联

- 推荐与当前记忆有关系的其他记忆
- 考虑关系强度
- 多跳关联推荐

---

## 二、冲突解决机制

### 2.1 冲突类型

| 类型 | 描述 | 检测方式 |
|------|------|----------|
| 内容冲突 | 相似 URI 但内容不同 | 内容哈希对比 |
| 时间冲突 | 新信息与旧信息矛盾 | 语义分析 |
| 依赖冲突 | 关联记忆矛盾 | 关系图分析 |

### 2.2 解决策略

| 策略 | 适用场景 | 行为 |
|------|----------|------|
| keep_latest | 时间冲突 | 保留最新版本 |
| keep_oldest | 历史优先 | 保留最老版本 |
| merge | 内容互补 | 合并内容 |
| keep_both | 无法判断 | 保留两者，标记冲突 |
| manual | 复杂冲突 | 等待用户决策 |

### 2.3 自动解决规则

| 条件 | 策略 |
|------|------|
| 优先级差异 > 3 | 保留高优先级 |
| 访问次数差异 > 10 | 保留高访问量 |
| 时间差异 > 30 天 | 提示用户确认 |
| 内容相似度 < 0.3 | 自动保留两者 |

---

## 三、多项目支持

### 3.1 项目隔离

- 每个项目独立的 SQLite 数据库
- 数据库位置：`{project_dir}/.claude/memory.db`
- 支持项目间记忆共享

### 3.2 共享记忆

- 标记为 `shared: true` 的记忆可跨项目访问
- 共享记忆存储在用户级数据库
- 项目可引用共享记忆

### 3.3 项目切换

- 自动检测当前项目目录
- 切换项目时自动加载数据库
- 支持手动切换：`/memory switch <project>`

---

## 四、记忆分析报告

### 4.1 报告内容

| 部分 | 内容 |
|------|------|
| 摘要 | 总记忆数、各类型分布、存储大小 |
| 使用分析 | 访问频率、最常访问、从未访问 |
| 质量分析 | 过时记忆、冲突数量、重复内容 |
| 演化分析 | 增长趋势、更新频率、归档统计 |
| 洞察 | 系统发现的问题和机会 |
| 推荐 | 建议执行的操作 |

### 4.2 报告触发

| 触发方式 | 条件 |
|----------|------|
| 手动触发 | `/memory stats --report` |
| 定期触发 | 每周自动生成（可配置） |
| 阈值触发 | 记忆数量超过配置值时 |

---

## 五、版本控制与回滚

### 5.1 版本创建

- 每次修改前自动创建快照
- 记录修改原因和来源
- 保留完整版本历史

### 5.2 版本对比

- 支持任意版本间差异对比
- 高亮显示变更内容
- 统计变更行数

### 5.3 版本回滚

- 支持回滚到任意历史版本
- 回滚前创建当前版本快照
- 记录回滚原因

---

## 六、导入导出

### 6.1 导出格式

| 格式 | 说明 | 用途 |
|------|------|------|
| JSON | 完整数据 | 备份、迁移 |
| Markdown | 可读格式 | 文档、分享 |
| CSV | 表格格式 | 分析、统计 |

### 6.2 导入策略

| 策略 | 说明 |
|------|------|
| skip | 跳过已存在的记忆 |
| overwrite | 覆盖已存在的记忆 |
| merge | 合并内容 |
| rename | 重命名导入的记忆 |
