# 架构设计

## 一、分层架构

### 1.1 用户交互层

负责与用户的所有交互，包括：

- **CLI 命令**：`/memory` 命令及其子命令
- **Web 管理界面**：可视化管理记忆
- **Hook 反馈**：自动化操作的反馈信息
- **Skill 接口**：Claude Code 调用的技能接口

### 1.2 业务逻辑层

核心业务处理：

- **记忆管理**：CRUD 操作、生命周期管理
- **演化引擎**：记忆更新、合并、冲突检测
- **推荐系统**：智能推荐相关记忆
- **冲突解决**：自动或手动解决记忆冲突
- **分析器**：记忆统计、报告生成

### 1.3 数据访问层

数据访问抽象：

- **SQLite 客户端**：数据库操作封装
- **版本管理**：记忆版本控制
- **快照引擎**：修改前快照创建
- **缓存管理**：热点数据缓存

### 1.4 存储层

持久化存储：

- **SQLite 数据库**：主数据存储
- **文件快照**：版本快照存储
- **导出文件**：JSON/Markdown 导出
- **备份文件**：定期备份

---

## 二、组件交互流程

### 2.1 记忆读取流程

```
用户请求 → CLI/Skill → MCP Server → Memory Manager
    → SQLite Client → 数据库 → 返回结果 → 格式化输出
```

### 2.2 自动记录流程

```
工具调用 → PostToolUse Hook → Hook Script
    → Memory Manager → 记录操作 → 更新统计
```

### 2.3 智能预加载流程

```
PreToolUse Hook → 分析上下文 → 匹配 disclosure
    → 加载相关记忆 → 注入 additionalContext
```

---

## 三、数据流设计

### 3.1 写入数据流

```
用户输入 → 参数验证 → 创建快照 → 写入数据库
    → 更新索引 → 更新缓存 → 返回结果
```

### 3.2 读取数据流

```
URI 解析 → 检查缓存 → 查询数据库 → 更新访问统计
    → 格式化内容 → 返回结果
```

### 3.3 搜索数据流

```
搜索关键词 → 分词处理 → 数据库查询 → 结果排序
    → 去重处理 → 格式化输出
```

---

## 四、扩展点设计

### 4.1 存储扩展

- 支持自定义存储后端
- 支持远程数据库连接
- 支持加密存储

### 4.2 检索扩展

- 支持语义搜索（向量数据库）
- 支持全文搜索
- 支持混合检索

### 4.3 分析扩展

- 支持自定义分析插件
- 支持导出分析报告
- 支持可视化图表
