# 数据库设计

## 一、当前实现

数据库表结构通过 `lib/db` ORM 自动创建和管理，无需手动维护 SQL 文件。

### 1.1 memories 表（记忆本体）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| uri | TEXT | URI 标识，唯一，索引 |
| content | TEXT | 记忆内容 |
| content_hash | TEXT | 内容哈希，索引 |
| priority | INTEGER | 优先级 0-10，默认 5 |
| disclosure | TEXT | 触发条件 |
| status | TEXT | 状态：active/deprecated/archived/deleted，索引 |
| access_count | INTEGER | 访问次数 |
| last_accessed_at | DATETIME | 最后访问时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |
| deprecated_at | DATETIME | 废弃时间 |
| metadata | TEXT | JSON 元数据 |

### 1.2 memory_paths 表（记忆路径）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| memory_id | INTEGER | 关联记忆 ID |
| path | TEXT | 关联路径，索引 |
| created_at | DATETIME | 创建时间 |

### 1.3 memory_versions 表（版本历史）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| memory_id | INTEGER | 关联记忆 ID，索引 |
| version | INTEGER | 版本号 |
| content | TEXT | 版本内容 |
| changed_at | DATETIME | 变更时间 |
| change_reason | TEXT | 变更原因 |
| changed_by | TEXT | 变更来源：user/auto/hook/import |

### 1.4 memory_relations 表（记忆关系）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| source_memory_id | INTEGER | 源记忆 ID，索引 |
| target_memory_id | INTEGER | 目标记忆 ID，索引 |
| relation_type | TEXT | 关系类型 |
| strength | REAL | 关系强度 0-1 |
| created_at | DATETIME | 创建时间 |

**关系类型**：
- `relates_to`：相关
- `depends_on`：依赖
- `contradicts`：矛盾
- `evolves_from`：演化自

### 1.5 sessions 表（会话记录）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| session_id | TEXT | 会话 ID，唯一 |
| project_dir | TEXT | 项目目录 |
| project_name | TEXT | 项目名称 |
| started_at | DATETIME | 开始时间 |
| ended_at | DATETIME | 结束时间 |
| summary | TEXT | 会话摘要 |
| memories_created | INTEGER | 创建记忆数 |
| memories_accessed | INTEGER | 访问记忆数 |
| operations_count | INTEGER | 操作次数 |

### 1.6 error_solutions 表（错误解决方案）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| error_pattern | TEXT | 错误模式（正则） |
| error_type | TEXT | 错误类型 |
| solution | TEXT | 解决方案 |
| source | TEXT | 来源：learned/manual/imported |
| success_count | INTEGER | 成功次数 |
| failure_count | INTEGER | 失败次数 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

## 二、ORM 模型定义

```python
class MemoryStatus(str, Enum):
    ACTIVE = "active"
    DEPRECATED = "deprecated"
    ARCHIVED = "archived"
    DELETED = "deleted"


class RelationType(str, Enum):
    RELATES_TO = "relates_to"
    DEPENDS_ON = "depends_on"
    CONTRADICTS = "contradicts"
    EVOLVES_FROM = "evolves_from"


class Memory(Model):
    __tablename__ = "memories"
    
    id = Integer(primary_key=True, auto_increment=True)
    uri = String(255, unique=True, index=True, nullable=False)
    content = Text(nullable=False)
    content_hash = String(64, index=True)
    priority = Integer(default=5)
    disclosure = Text(default="")
    status = String(20, default=MemoryStatus.ACTIVE.value, index=True)
    access_count = Integer(default=0)
    last_accessed_at = DateTime()
    created_at = DateTime(nullable=False)
    updated_at = DateTime(nullable=False)
    deprecated_at = DateTime()
    metadata = Text(default="{}")
```

---

## 三、数据存储位置

数据库文件位于 `{project_root}/lazygophers/ccplugin/memory/memory.db`。

此目录遵循项目约定，所有插件数据统一存储在 `lazygophers/ccplugin/<plugin-name>/` 目录下。

---

## 四、核心 API

### 4.1 CRUD 操作

| 函数 | 说明 |
|------|------|
| `create_memory(uri, content, priority, disclosure, metadata)` | 创建记忆 |
| `get_memory(uri, increment_access)` | 获取记忆 |
| `update_memory(uri, content, priority, disclosure, metadata, append, old_text, new_text)` | 更新记忆 |
| `delete_memory(uri, soft)` | 删除记忆 |

### 4.2 搜索和列表

| 函数 | 说明 |
|------|------|
| `search_memories(query, uri_prefix, priority_min, priority_max, status, limit)` | 搜索记忆 |
| `list_memories(uri_prefix, priority_min, priority_max, status, limit, offset)` | 列出记忆 |
| `get_memories_by_priority(max_priority)` | 按优先级获取 |

### 4.3 生命周期管理

| 函数 | 说明 |
|------|------|
| `set_priority(uri, priority)` | 设置优先级 |
| `deprecate_memory(uri, reason)` | 废弃记忆 |
| `archive_memory(uri)` | 归档记忆 |
| `restore_memory(uri)` | 恢复记忆 |

### 4.4 版本控制

| 函数 | 说明 |
|------|------|
| `get_versions(uri, limit)` | 获取版本列表 |
| `get_version(uri, version)` | 获取特定版本 |
| `rollback_to_version(uri, version)` | 回滚到版本 |
| `diff_versions(uri, version1, version2)` | 版本对比 |

### 4.5 关系管理

| 函数 | 说明 |
|------|------|
| `add_relation(source_uri, target_uri, relation_type, strength)` | 添加关系 |
| `get_relations(uri, direction)` | 获取关系 |
| `remove_relation(source_uri, target_uri, relation_type)` | 移除关系 |

### 4.6 导入导出

| 函数 | 说明 |
|------|------|
| `export_memories(uri_prefix, include_versions, include_relations)` | 导出记忆 |
| `import_memories(data, strategy)` | 导入记忆 |

### 4.7 统计和清理

| 函数 | 说明 |
|------|------|
| `get_stats()` | 获取统计信息 |
| `clean_memories(unused_days, deprecated_days, dry_run)` | 清理记忆 |

### 4.8 会话管理

| 函数 | 说明 |
|------|------|
| `create_session(session_id, project_dir, project_name)` | 创建会话 |
| `end_session(session_id, summary)` | 结束会话 |

### 4.9 错误解决方案

| 函数 | 说明 |
|------|------|
| `record_error_solution(error_pattern, solution, error_type, source)` | 记录解决方案 |
| `find_error_solution(error_message)` | 查找解决方案 |
| `mark_solution_success(solution_id, success)` | 标记成功/失败 |
